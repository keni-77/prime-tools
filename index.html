<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Prime</title>
  <link rel="icon" href="ğŸŒ¸M.png">

  <style>
    body {
      background-color: #fff5f8;
      font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", sans-serif;
      text-align: center;
      padding-top: 50px;
      color: #444;
    }

    h2 {
      color: #ff7aa8;
      font-size: 2rem;
      margin-bottom: 20px;
    }

    #num {
      padding: 10px 15px;
      font-size: 1.2rem;
      border: 2px solid #ffb6d4;
      border-radius: 12px;
      outline: none;
      width: 260px;
      background: #fff;
      transition: 0.2s;
    }

    #num:focus {
      border-color: #ff7aa8;
      box-shadow: 0 0 5px #ffb6d4;
    }

    button {
      padding: 10px 20px;
      margin-left: 10px;
      font-size: 1.1rem;
      background-color: #ff9ecb;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      transition: 0.2s;
    }

    button:hover {
      background-color: #ff7aa8;
      transform: scale(1.05);
    }

    #result {
      font-family: "Segoe UI", "Arial", sans-serif;
      line-height: 1.6;
      font-size: 1.5rem;
      color:hotpink;
      word-break: break-all;
    }

    .box {
      background: snow;
      display: inline-block;
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(255, 150, 180, 0.5);
    }

    button.glow {
      animation: popGlow 0.25s ease-out;
    }

    @keyframes popGlow {
      0% {
          transform: scale(1);
          box-shadow: 0 0 0px rgba(255, 150, 200, 0.0);
      }
      50% {
          transform: scale(1.12);
          box-shadow: 0 0 15px rgba(255, 150, 200, 0.6);
      }
      100% {
          transform: scale(1);
          box-shadow: 0 0 0px rgba(255, 150, 200, 0.0);
      }
    }

    /* ãã®å ´ã§ãã‚‹ãã‚‹å›ã‚‹èŠ±ã³ã‚‰ */
    .loader {
      display: none;
      margin: 20px auto;
      width: 60px;
      height: 60px;
      position: relative;
    }

    .loader span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to   { transform: translate(-50%, -50%) rotate(360deg); }
    }

  </style>
</head>
<body>

<div class="box">
  <h2>ğŸŒ¸ ç´ æ•°ã«é–¢ã™ã‚‹ãƒ„ãƒ¼ãƒ« ğŸŒ¸</h2>

  <input id="num" type="text" placeholder="æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ã­">
  <button onclick="run()">ç´ å› æ•°åˆ†è§£</button>
  <button onclick="runNthPrime()">nç•ªç›®ã®ç´ æ•°</button>
  <button onclick="runCountPrime()">nä»¥ä¸‹ã®ç´ æ•°ã®æ•°</button>

  <p id="result"></p>

  <div class="loader" id="loader">
    <span>ğŸŒ¸</span>
  </div>

</div>

<script>
// ç´ å› æ•°åˆ†è§£ã‚³ãƒ¼ãƒ‰
function printPrimeFactorization(inputStr) {
  // BigInt ã«å¤‰æ›
  let n;
  try {
    n = BigInt(inputStr);
  } catch {
    return "ğŸŒ¸ æ­£ã—ã„æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ã­ ğŸŒ¸";
  }

  const sup = ["â°","Â¹","Â²","Â³","â´","âµ","â¶","â·","â¸","â¹"];
  const toSup = (x) => String(x).split("").map(c => sup[Number(c)]).join("");

  // 1ä»¥ä¸‹ãªã‚‰ã‚¨ãƒ©ãƒ¼
  if (n <= 1n) {
    return `ğŸŒ¸ ${n} ã¯ç´ å› æ•°åˆ†è§£ã§ãã¾ã›ã‚“ ğŸŒ¸`;
  }

  // ç´ æ•°ãƒã‚§ãƒƒã‚¯
  function isPrime(x) {
    if (x <= 1n) return false;
    for (let i = 2n; i * i <= x; i++) {
      if (x % i === 0n) return false;
    }
    return true;
  }

  if (isPrime(n)) {
    return `ğŸŒ¸ ${n} ã¯ç´ æ•°ã§ã™ ğŸŒ¸`;
  }

  // ç´ å› æ•°åˆ†è§£
  let original = n;
  let res = [];

  for (let i = 2n; i * i <= n; i++) {
    if (n % i === 0n) {
      let ex = 0;
      while (n % i === 0n) {
        ex++;
        n /= i;
      }
      res.push([i, ex]);
    }
  }

  if (n !== 1n) {
    res.push([n, 1]);
  }

  let output = `${original} = `;
  output += res.map(([p, e]) => {
    return e === 1 ? `${p}` : `${p}${toSup(e)}`;
  }).join(" Ã— ");

  return output;
}

function run() {
  const btn = document.querySelector("button");
  const loader = document.getElementById("loader");
  const result = document.getElementById("result");

  // å…‰ã‚‹æ¼”å‡º
  btn.classList.add("glow");
  setTimeout(() => btn.classList.remove("glow"), 250);

  const inputStr = document.getElementById("num").value.trim();

  // ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
  result.textContent = "â³ ãƒ­ãƒ¼ãƒ‰ä¸­â€¦";
  loader.style.display = "block";

  // UIæ›´æ–°ã®ãŸã‚å°‘ã—é…ã‚‰ã›ã¦è¨ˆç®—é–‹å§‹
  setTimeout(() => {
    result.textContent = printPrimeFactorization(inputStr);
    loader.style.display = "none"; // çµ‚ã‚ã£ãŸã‚‰æ¶ˆã™
  }, 50);
}

// è¶…é«˜é€Ÿ nç•ªç›®ã®ç´ æ•°ï¼ˆSegmented Sieve + å¥‡æ•°ã®ã¿ï¼‰
async function nthPrimeUltra(n) {
  n = Number(n);
  if (!Number.isInteger(n) || n < 1) {
    return "ğŸŒ¸ 1ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥ã‚Œã¦ã­ ğŸŒ¸";
  }

  if (n === 1) return "ğŸŒ¸ 1ç•ªç›®ã®ç´ æ•°ã¯ 2 ã§ã™ ğŸŒ¸";

  // --- ä¸Šé™æ¨å®š ---
  const nn = n;
  let limit = Math.ceil(nn * (Math.log(nn) + Math.log(Math.log(nn))));
  limit = Math.floor(limit * 2.0);
  if (limit < 100) limit = 100;

  const segmentSize = 5_000_000; // 5ç™¾ä¸‡ãšã¤å‡¦ç†
  const sqrtLimit = Math.floor(Math.sqrt(limit));

  // å°ã•ã„ç´ æ•°ã‚’é€šå¸¸ã®ç¯©ã§ä½œã‚‹
  const small = new Uint8Array(sqrtLimit + 1);
  const basePrimes = [];

  for (let i = 2; i <= sqrtLimit; i++) {
    if (!small[i]) {
      basePrimes.push(i);
      for (let j = i * 2; j <= sqrtLimit; j += i) {
        small[j] = 1;
      }
    }
  }

  let count = 1; // 2 ã¯ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿

  // --- åˆ†å‰²ç¯© ---
  for (let low = 3; low <= limit; low += segmentSize) {
    const high = Math.min(low + segmentSize - 1, limit);
    const size = Math.floor((high - low) / 2) + 1;
    const segment = new Uint8Array(size);

    for (const p of basePrimes) {
      let start = Math.max(p * p, Math.ceil(low / p) * p);
      if (start % 2 === 0) start += p;

      for (let j = start; j <= high; j += 2 * p) {
        segment[Math.floor((j - low) / 2)] = 1;
      }
    }

    for (let i = 0; i < size; i++) {
      if (!segment[i]) {
        count++;
        if (count === n) {
          const prime = low + i * 2;
          return `ğŸŒ¸ ${n} ç•ªç›®ã®ç´ æ•°ã¯ ${prime} ã§ã™ ğŸŒ¸`;
        }
      }
    }

    // UI ã‚’æ­¢ã‚ãªã„ãŸã‚ã®ä¼‘æ†©
    await new Promise(r => setTimeout(r));
  }

  return "ğŸŒ¸ ç¯„å›²ãŒè¶³ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆnãŒå¤§ãã™ãã‚‹ã‹ã‚‚ï¼‰ğŸŒ¸";
}

function runNthPrime() {
  const btn = document.querySelector("button[onclick='runNthPrime()']");
  const loader = document.getElementById("loader");
  const result = document.getElementById("result");
  const inputStr = document.getElementById("num").value.trim();

  btn.classList.add("glow");
  setTimeout(() => btn.classList.remove("glow"), 250);

  result.textContent = "â³ ãƒ­ãƒ¼ãƒ‰ä¸­â€¦";
  loader.style.display = "block";

  setTimeout(async () => {
    result.textContent = await nthPrimeUltra(inputStr);
    loader.style.display = "none";
  }, 50);
}

async function countPrimesUnder(n) {
  n = Number(n);
  if (!Number.isInteger(n) || n < 2) {
    return "ğŸŒ¸ 2ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥ã‚Œã¦ã­ ğŸŒ¸";
  }

  // 2 ã¯ç´ æ•°
  let count = 1;

  // å¶æ•°ã‚’é™¤ã
  const limit = n;
  const segmentSize = 5_000_000;
  const sqrtLimit = Math.floor(Math.sqrt(limit));

  // å°ã•ã„ç´ æ•°ã‚’é€šå¸¸ã®ç¯©ã§ä½œã‚‹
  const small = new Uint8Array(sqrtLimit + 1);
  const basePrimes = [];

  for (let i = 2; i <= sqrtLimit; i++) {
    if (!small[i]) {
      basePrimes.push(i);
      for (let j = i * 2; j <= sqrtLimit; j += i) {
        small[j] = 1;
      }
    }
  }

  // åˆ†å‰²ç¯©ã§ n ä»¥ä¸‹ã®ç´ æ•°ã‚’æ•°ãˆã‚‹
  for (let low = 3; low <= limit; low += segmentSize) {
    const high = Math.min(low + segmentSize - 1, limit);
    const size = Math.floor((high - low) / 2) + 1;
    const segment = new Uint8Array(size);

    for (const p of basePrimes) {
      let start = Math.max(p * p, Math.ceil(low / p) * p);
      if (start % 2 === 0) start += p;

      for (let j = start; j <= high; j += 2 * p) {
        segment[Math.floor((j - low) / 2)] = 1;
      }
    }

    for (let i = 0; i < size; i++) {
      if (!segment[i]) {
        count++;
      }
    }

    // UI ã‚’æ­¢ã‚ãªã„
    await new Promise(r => setTimeout(r));
  }

  return `ğŸŒ¸ ${n} ä»¥ä¸‹ã®ç´ æ•°ã®å€‹æ•°ã¯ ${count} å€‹ã§ã™ ğŸŒ¸`;
}

function runCountPrime() {
  const btn = document.querySelector("button[onclick='runCountPrime()']");
  const loader = document.getElementById("loader");
  const result = document.getElementById("result");
  const inputStr = document.getElementById("num").value.trim();

  btn.classList.add("glow");
  setTimeout(() => btn.classList.remove("glow"), 250);

  result.textContent = "â³ ãƒ­ãƒ¼ãƒ‰ä¸­â€¦";
  loader.style.display = "block";

  setTimeout(async () => {
    result.textContent = await countPrimesUnder(inputStr);
    loader.style.display = "none";
  }, 50);
}

</script>

</body>
</html>